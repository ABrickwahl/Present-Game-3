<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>ðŸŽ„ Xmas Bitches</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Indie+Flower&family=Caveat&family=Lobster&family=Roboto&display=swap" rel="stylesheet">

<style>
body {
  margin:0;
  padding:15px;
  font-family: Roboto, sans-serif;
  background: url("./assets/images/xmas-tree.jpg") center/cover no-repeat fixed;
  color:#000;
}

h1 { text-align:center; }

.card {
  background: rgba(30,30,30,0.85);
  padding:15px;
  border-radius:10px;
  margin-bottom:15px;
}

input, select, button {
  width:100%;
  padding:8px;
  margin-top:8px;
  border-radius:6px;
  border:none;
}

button {
  background:#d9534f;
  color:white;
  cursor:pointer;
}

button:disabled {
  background:#555;
  cursor:not-allowed;
}

.entry-card {
  font-size:26px;
  text-align:center;
  color:#ffd700;
}

canvas {
  background:white;
  border-radius:6px;
  width:100%;
  margin-top:8px;
}

#turnIndicator {
  font-weight:bold;
  margin-bottom:10px;
}

#winnerCard {
  display:none;
  background: gold;
  color:black;
  font-size:24px;
  padding:20px;
  border-radius:10px;
  text-align:center;
}
</style>
</head>

<body>

<h1>ðŸŽ„ 2025 Presents to Present ðŸŽ„</h1>

<div class="card" id="joinCard">
  <input id="playerName" placeholder="Your name">
  <input id="roomId" placeholder="Room code">
  <button id="joinBtn">Join Room</button>
</div>

<div class="card" id="roomCard" style="display:none;">
  Room: <span id="roomCode"></span>
</div>

<div class="card" id="playersCard" style="display:none;">
  <ul id="playersList"></ul>
</div>

<div class="card" id="entryCard" style="display:none;">
  <input id="entryText" placeholder="Add entry">
  <select id="style">
    <option value="font">Random Font</option>
    <option value="handwriting">Handwriting</option>
  </select>
  <canvas id="canvas" width="300" height="150"></canvas>
  <button id="clearCanvas">Clear</button>
  <button id="addEntryBtn">Add Entry</button>
</div>

<div class="card" id="playCard" style="display:none;">
  <div id="turnIndicator"></div>
  <button id="drawBtn">Draw Entry</button>
  <div id="entryDisplay"></div>
  <select id="guessSelect"></select>
  <button id="guessBtn">Guess</button>
</div>

<div id="winnerCard"></div>

<script>
/* ðŸ”¥ FIREBASE INIT */
firebase.initializeApp({
  apiKey: "AIzaSyBcfYtibV2vzCG_rchAX8KqUnfJNbnpyQM",
  authDomain: "xmas-guessing-game-e744e.firebaseapp.com",
  projectId: "xmas-guessing-game-e744e"
});
const db = firebase.firestore();

/* ðŸŽ® GLOBAL STATE */
let roomRef, playerName, roomId, currentEntry = null;
const fonts = ['Pacifico','Indie Flower','Caveat','Lobster','Roboto'];

/* ðŸ“¦ DOM */
const joinBtn = document.getElementById("joinBtn");
const playerNameInput = document.getElementById("playerName");
const roomIdInput = document.getElementById("roomId");
const roomCodeSpan = document.getElementById("roomCode");
const playersList = document.getElementById("playersList");
const turnIndicator = document.getElementById("turnIndicator");
const guessSelect = document.getElementById("guessSelect");
const guessBtn = document.getElementById("guessBtn");
const entryDisplay = document.getElementById("entryDisplay");

/* âœï¸ CANVAS */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let drawing=false;

canvas.onmousedown=()=>drawing=true;
canvas.onmouseup=()=>{drawing=false;ctx.beginPath();};
canvas.onmousemove=e=>{
  if(!drawing) return;
  const r=canvas.getBoundingClientRect();
  ctx.lineWidth=2;
  ctx.lineCap="round";
  ctx.lineTo(e.clientX-r.left,e.clientY-r.top);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(e.clientX-r.left,e.clientY-r.top);
};

document.getElementById("clearCanvas").onclick=()=>ctx.clearRect(0,0,300,150);

/* ðŸšª JOIN ROOM */
joinBtn.onclick = async () => {
  playerName = playerNameInput.value.trim();
  roomId = roomIdInput.value.trim();
  if(!playerName || !roomId) return alert("Enter name and room code");

  roomRef = db.collection("games").doc(roomId);

  await roomRef.set({
    players: {
      [playerName]: { score:0, lastSeen:Date.now() }
    },
    turnOrder: firebase.firestore.FieldValue.arrayUnion(playerName),
    turnIndex: 0,
    currentTurn: playerName
  }, { merge:true });

  document.getElementById("joinCard").style.display="none";
  document.getElementById("roomCard").style.display="block";
  document.getElementById("playersCard").style.display="block";
  document.getElementById("entryCard").style.display="block";
  document.getElementById("playCard").style.display="block";
  roomCodeSpan.textContent = roomId;

  startHeartbeat();
  listenRoom();
};

/* â¤ï¸ HEARTBEAT */
function startHeartbeat(){
  setInterval(()=>{
    roomRef.update({
      [`players.${playerName}.lastSeen`]: Date.now()
    });
  }, 5000);
}

/* ðŸ‘‚ LISTEN */
function listenRoom(){
  roomRef.onSnapshot(snap=>{
    const data = snap.data();
    updatePlayers(data.players);
    updateTurn(data);
  });
}

/* ðŸ‘¥ PLAYERS */
function updatePlayers(players){
  playersList.innerHTML="";
  guessSelect.innerHTML="";
  const now = Date.now();

  Object.keys(players).forEach(p=>{
    const active = (now - players[p].lastSeen) < 15000;
    const li = document.createElement("li");
    li.textContent = `${p} ${active ? "" : "(offline)"}`;
    playersList.appendChild(li);

    if(active){
      const opt = document.createElement("option");
      opt.value = p;
      opt.textContent = p;
      guessSelect.appendChild(opt);
    }
  });
}

/* ðŸŽ¯ TURN */
function updateTurn(data){
  turnIndicator.textContent = `ðŸŽ¯ Turn: ${data.currentTurn}`;
  guessBtn.disabled = data.currentTurn !== playerName;
}

/* âž• ADD ENTRY */
document.getElementById("addEntryBtn").onclick = async ()=>{
  const text = document.getElementById("entryText").value.trim();
  if(!text) return;

  const entry = {
    text,
    author: playerName,
    style: document.getElementById("style").value,
    in_play:true
  };

  if(entry.style==="handwriting"){
    entry.image = canvas.toDataURL();
  } else {
    entry.font = fonts[Math.floor(Math.random()*fonts.length)];
  }

  await roomRef.collection("entries").add(entry);
  document.getElementById("entryText").value="";
  ctx.clearRect(0,0,300,150);
};

/* ðŸŽ² DRAW */
document.getElementById("drawBtn").onclick = async ()=>{
  const snap = await roomRef.collection("entries").where("in_play","==",true).get();
  if(snap.empty) return alert("No entries left");

  const doc = snap.docs[Math.floor(Math.random()*snap.docs.length)];
  currentEntry = { id:doc.id, ...doc.data() };

  entryDisplay.innerHTML="";
  if(currentEntry.style==="handwriting"){
    const img = new Image();
    img.src = currentEntry.image;
    img.width = 300;
    entryDisplay.appendChild(img);
  } else {
    const div = document.createElement("div");
    div.className="entry-card";
    div.style.fontFamily = currentEntry.font;
    div.textContent = currentEntry.text;
    entryDisplay.appendChild(div);
  }
};

/* âœ… GUESS */
guessBtn.onclick = async ()=>{
  if(!currentEntry) return;

  const snap = await roomRef.get();
  const data = snap.data();
  const order = data.turnOrder;
  const players = data.players;

  let next = data.turnIndex;
  do {
    next = (next + 1) % order.length;
  } while(Date.now() - players[order[next]].lastSeen > 15000);

  await roomRef.update({
    turnIndex: next,
    currentTurn: order[next]
  });

  currentEntry = null;
  entryDisplay.innerHTML="";
};
</script>

</body>
</html>

