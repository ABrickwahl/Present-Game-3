<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Xmas Bitches</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Indie+Flower&family=Caveat&family=Lobster&family=Roboto&display=swap" rel="stylesheet">

<style>
body {
  background: url("./assets/images/xmas-tree.jpg") center/cover no-repeat fixed;
  color:#fff;
  font-family:Roboto;
}
.card {
  background: rgba(30,30,30,0.85);
  padding:15px;
  border-radius:10px;
  margin-bottom:15px;
}
button {
  background:#d9534f;
  color:#fff;
  border:none;
  padding:8px;
  border-radius:5px;
  cursor:pointer;
}
button:disabled {
  background:#555;
  cursor:not-allowed;
}
canvas {
  background:#fff;
  border-radius:6px;
  width:100%;
}
.entry-card {
  font-size:26px;
  text-align:center;
  color:#ffd700;
}
#winnerCard {
  display:none;
  background:gold;
  color:#000;
  font-size:24px;
  text-align:center;
  padding:20px;
  border-radius:10px;
}
</style>
</head>

<body>

<h1>ðŸŽ„ 2025 Presents to Present ðŸŽ„</h1>

<div class="card" id="roomCard">
  <input id="playerName" placeholder="Your name">
  <input id="roomId" placeholder="Room code">
  <button onclick="joinRoom()">Join Room</button>
</div>

<div class="card" id="roomInfo" style="display:none;">
  Room: <span id="roomCode"></span>
</div>

<div class="card" id="playersCard" style="display:none;">
  <ul id="players"></ul>
</div>

<div class="card" id="entryCard" style="display:none;">
  <input id="entryText" placeholder="Entry">
  <select id="style">
    <option value="font">Font</option>
    <option value="handwriting">Handwriting</option>
  </select>
  <canvas id="canvas" width="300" height="150"></canvas>
  <button onclick="clearCanvas()">Clear</button>
  <button onclick="addEntry()">Add Entry</button>
</div>

<div class="card" id="playCard" style="display:none;">
  <div id="turnIndicator"></div>
  <button onclick="drawEntry()">Draw Entry</button>
  <div id="entry"></div>
  <select id="guess"></select>
  <button id="guessBtn" onclick="submitGuess()">Guess</button>
</div>

<div id="winnerCard"></div>

<script>
/* ðŸ”¥ FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyBcfYtibV2vzCG_rchAX8KqUnfJNbnpyQM",
  authDomain: "xmas-guessing-game-e744e.firebaseapp.com",
  projectId: "xmas-guessing-game-e744e"
});
const db = firebase.firestore();

/* ðŸŽ® STATE */
let roomRef, roomId, playerName;
let currentEntry = null;
const fonts = ['Pacifico','Indie Flower','Caveat','Lobster','Roboto'];

/* âœï¸ CANVAS */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let drawing=false;
canvas.onmousedown=()=>drawing=true;
canvas.onmouseup=()=>{drawing=false;ctx.beginPath();}
canvas.onmousemove=e=>{
  if(!drawing)return;
  const r=canvas.getBoundingClientRect();
  ctx.lineWidth=2;
  ctx.lineTo(e.clientX-r.left,e.clientY-r.top);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(e.clientX-r.left,e.clientY-r.top);
};
function clearCanvas(){ctx.clearRect(0,0,300,150);}

/* ðŸšª JOIN */
async function joinRoom(){
  playerName=playerNameInput.value.trim();
  roomId=roomIdInput.value.trim();
  if(!playerName||!roomId) return alert("Missing fields");

  roomRef=db.collection("games").doc(roomId);

  await roomRef.set({
    players:{
      [playerName]:{score:0,lastSeen:Date.now(),active:true}
    },
    turnOrder: firebase.firestore.FieldValue.arrayUnion(playerName),
    turnIndex:0,
    currentTurn:playerName
  },{merge:true});

  roomCard.style.display="none";
  roomInfo.style.display="block";
  playersCard.style.display="block";
  entryCard.style.display="block";
  playCard.style.display="block";
  roomCode.textContent=roomId;

  heartbeat();
  listen();
}

/* â¤ï¸ HEARTBEAT */
function heartbeat(){
  setInterval(()=>{
    roomRef.update({
      [`players.${playerName}.lastSeen`]:Date.now(),
      [`players.${playerName}.active`]:true
    });
  },5000);
}

/* ðŸ‘‚ LISTEN */
function listen(){
  roomRef.onSnapshot(s=>{
    const d=s.data();
    updatePlayers(d.players);
    updateTurn(d);
  });
}

/* ðŸ‘¥ PLAYERS */
function updatePlayers(players){
  playersList.innerHTML="";
  guess.innerHTML="";
  const now=Date.now();

  for(const p in players){
    const active=(now-players[p].lastSeen)<15000;
    players[p].active=active;
    playersList.innerHTML+=`<li>${p} ${active?"":"(offline)"}</li>`;
    if(active){
      const o=document.createElement("option");
      o.value=p;o.textContent=p;
      guess.appendChild(o);
    }
  }
}

/* ðŸŽ¯ TURN */
function updateTurn(data){
  turnIndicator.textContent=`Turn: ${data.currentTurn}`;
  guessBtn.disabled=data.currentTurn!==playerName;
}

/* âž• ENTRY */
async function addEntry(){
  const text=entryText.value.trim();
  if(!text)return;

  const entry={
    text,
    style:style.value,
    author:playerName,
    in_play:true
  };
  if(style.value==="handwriting") entry.image=canvas.toDataURL();
  else entry.font=fonts[Math.floor(Math.random()*fonts.length)];

  await roomRef.collection("entries").add(entry);
  entryText.value="";
  clearCanvas();
}

/* ðŸŽ² DRAW */
async function drawEntry(){
  const snap=await roomRef.collection("entries").where("in_play","==",true).get();
  if(snap.empty)return alert("No entries");

  currentEntry={id:snap.docs[0].id,...snap.docs[0].data()};
  entry.innerHTML="";

  if(currentEntry.style==="handwriting"){
    const img=new Image();img.src=currentEntry.image;img.width=300;
    entry.appendChild(img);
  } else {
    const d=document.createElement("div");
    d.className="entry-card";
    d.style.fontFamily=currentEntry.font;
    d.textContent=currentEntry.text;
    entry.appendChild(d);
  }
}

/* âœ… GUESS */
async function submitGuess(){
  if(!currentEntry)return;

  const roomSnap=await roomRef.get();
  const data=roomSnap.data();
  const players=data.players;
  const order=data.turnOrder;

  let next=data.turnIndex;
  do{
    next=(next+1)%order.length;
  } while(!players[order[next]].active && next!==data.turnIndex);

  await roomRef.update({
    turnIndex:next,
    currentTurn:order[next]
  });

  currentEntry=null;
  entry.innerHTML="";
}
</script>
</body>
</html>
